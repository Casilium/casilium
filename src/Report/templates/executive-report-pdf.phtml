<?php

declare(strict_types=1);

use Organisation\Entity\Organisation;

/** @var array $this->stats */
/** @var Organisation $this->organisation */

$stats            = $this->stats;
$organisationName = $this->organisation->getName();

if ($this->startDate->format('m') === $this->endDate->format('m')) {
    $reportMonth = $this->startDate->format('F Y');
} else {
    $reportMonth = sprintf('%s to %s', $this->startDate->format('F Y'), $this->endDate->format('F Y'));
}

// Calculate bar widths as percentage of the largest value per group
$incidentMax = max($stats['totalIncident'], $stats['totalIncidentComplete'], 1);
$requestMax  = max($stats['totalRequest'], $stats['totalRequestComplete'], 1);

$barWidths = [
    'incidentCreated'  => round(($stats['totalIncident'] / $incidentMax) * 100),
    'incidentComplete' => round(($stats['totalIncidentComplete'] / $incidentMax) * 100),
    'requestCreated'   => round(($stats['totalRequest'] / $requestMax) * 100),
    'requestComplete'  => round(($stats['totalRequestComplete'] / $requestMax) * 100),
];

$incidentCompleteRate = $stats['totalIncident'] > 0
    ? ($stats['totalIncidentComplete'] / $stats['totalIncident']) * 100
    : 0;
$requestCompleteRate = $stats['totalRequest'] > 0
    ? ($stats['totalRequestComplete'] / $stats['totalRequest']) * 100
    : 0;

$incidentCompleteRateDisplay = rtrim(rtrim(number_format($incidentCompleteRate, 1), '0'), '.');
$requestCompleteRateDisplay  = rtrim(rtrim(number_format($requestCompleteRate, 1), '0'), '.');
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page {
            margin: 54pt;
            size: A4 portrait;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
            margin: 0;
            padding: 0;
        }

        .header {
            border-bottom: 1px solid #000;
            padding-bottom: 10pt;
            margin-bottom: 16pt;
        }

        .header h1 {
            font-size: 18pt;
            margin: 0 0 4pt 0;
        }

        .header .subtitle {
            font-size: 12pt;
            margin: 0;
        }

        p {
            margin: 0 0 10pt 0;
        }

        .bold {
            font-weight: bold;
        }

        table.stats {
            width: 100%;
            border-collapse: collapse;
            margin: 10pt 0 16pt 0;
            font-size: 11pt;
        }

        table.stats th {
            background-color: #4472c4;
            color: #fff;
            padding: 8pt 10pt;
            text-align: left;
            font-weight: bold;
        }

        table.stats td {
            padding: 8pt 10pt;
            text-align: left;
            background-color: #e9edf4;
        }

        /* Two-column layout using table */
        table.layout {
            width: 100%;
            border-collapse: collapse;
        }

        table.layout td {
            vertical-align: top;
            padding: 0;
        }

        table.layout td.col-text {
            width: 48%;
            padding-right: 2%;
        }

        table.layout td.col-chart {
            width: 50%;
        }

        /* Chart built with tables */
        .chart-title {
            font-size: 13pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 6pt;
        }

        table.legend {
            margin: 0 auto 10pt auto;
            border-collapse: collapse;
        }

        table.legend td {
            padding: 0 8pt;
            font-size: 10pt;
            vertical-align: middle;
        }

        .swatch {
            width: 12pt;
            height: 12pt;
        }

        .chart-group-label {
            font-size: 11pt;
            font-weight: bold;
            margin: 8pt 0 4pt 0;
        }

        table.bars {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6pt;
        }

        table.bars td {
            padding: 3pt 0;
            font-size: 10pt;
            vertical-align: middle;
        }

        table.bars td.bar-label {
            width: 60pt;
        }

        table.bars td.bar-cell {
            padding: 3pt 4pt;
        }

        table.bars td.bar-value {
            width: 30pt;
            text-align: right;
        }

        .bar-track {
            width: 100%;
            height: 16pt;
            background-color: #f0f0f0;
        }

        .bar-track td {
            padding: 0;
            height: 16pt;
        }

        .page-break {
            page-break-before: always;
        }

        table.unresolved {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12pt;
            font-size: 10pt;
        }

        table.unresolved th {
            background-color: #222;
            color: #fff;
            padding: 6pt 8pt;
            text-align: left;
        }

        table.unresolved td {
            padding: 6pt 8pt;
            vertical-align: top;
            border-bottom: 0;
        }

        .unresolved-meta {
            color: #444;
            font-size: 9pt;
        }

        .unresolved-desc td {
            padding-bottom: 6pt;
        }

        .unresolved-sep td {
            padding: 0;
            height: 1px;
            background-color: #999;
            font-size: 0;
            line-height: 0;
        }

        .footer {
            position: fixed;
            bottom: -28pt;
            right: 0;
            left: 0;
            text-align: right;
            font-size: 9pt;
            color: #666;
        }

        .footer:before {
            content: "Page " counter(page);
        }
    </style>
</head>
<body>
    <table style="width: 100%; border-bottom: 1px solid #000; margin-bottom: 16pt; border-collapse: collapse;">
        <tr>
            <td style="vertical-align: bottom; padding: 0 0 10pt 0;">
                <h1 style="font-size: 18pt; margin: 0 0 4pt 0;">Executive Summary Report</h1>
                <p style="font-size: 12pt; margin: 0;"><?= $this->escapeHtml($organisationName) ?>, <?= $this->escapeHtml($reportMonth) ?></p>
            </td>
            <td style="text-align: right; vertical-align: top; padding: 0 0 10pt 0;">
                <img src="<?= $this->escapeHtmlAttr($this->logoPath) ?>" width="188">
            </td>
        </tr>
    </table>

    <p>
        This Executive Summary Report has been compiled to provide you with a breakdown of support
        tickets that have been received during the specified period.
    </p>

    <p>
        In order to help you identify the types of support requests that have been received we have
        broken them down into &ldquo;Incidents&rdquo; and &ldquo;Requests&rdquo;. We have defined these terms below for
        your convenience and understanding.
    </p>

    <p class="bold">Incident:</p>
    <p>An unplanned interruption to an IT service or reduction in the quality of an IT service.</p>

    <p class="bold">Service Request:</p>
    <p>
        A request from a user for something to be provided &ndash; for example, a request for information
        or advice; to reset a password; or to install a workstation for a new user.
    </p>

    <table class="layout">
        <tr>
            <td class="col-text">
                <p class="bold">Results:</p>
                <p>
                    The report shows that over the period defined above, a total of
                    <?= (int) $stats['total'] ?> tickets were received, of which <?= (int) $stats['totalComplete'] ?>
                    have been resolved. <?= (int) $stats['totalIncident'] ?> were received due to incidents,
                    and <?= (int) $stats['totalRequest'] ?> were due to general user requests.
                </p>
                <p>
                    This information has been broken down further in the table below for clarity.
                </p>
                <p class="bold">Incident SLA Compliance:</p>
                <?php if ($stats['incidentSla']['total'] > 0): ?>
                <p>
                    <?= rtrim(rtrim(number_format($stats['incidentSla']['rate'], 1), '0'), '.') ?>%
                    (<?= (int) $stats['incidentSla']['within'] ?> of <?= (int) $stats['incidentSla']['total'] ?>
                    incidents met SLA).
                </p>
                <?php else: ?>
                <p>Not available (no incident SLA tickets in period).</p>
                <?php endif; ?>
            </td>
            <td class="col-chart">
                <div class="chart-title">Ticket Statistics</div>

                <table class="legend">
                    <tr>
                        <td><div class="swatch" style="background-color: #a32828;"></div></td>
                        <td>Created (<?= (int) $stats['total'] ?>)</td>
                        <td><div class="swatch" style="background-color: #73ea2c;"></div></td>
                        <td>Complete (<?= (int) $stats['totalComplete'] ?>)</td>
                    </tr>
                </table>

                <div class="chart-group-label">
                    Incidents (<?= (int) $stats['totalIncident'] ?>) - <?= $incidentCompleteRateDisplay ?>% complete
                </div>
                <table class="bars">
                    <tr>
                        <td class="bar-label">Created</td>
                        <td class="bar-cell">
                            <table class="bar-track" cellpadding="0" cellspacing="0">
                                <tr>
                                    <?php if ($barWidths['incidentCreated'] > 0): ?>
                                    <td style="width: <?= $barWidths['incidentCreated'] ?>%; background-color: #a32828;"></td>
                                    <?php endif; ?>
                                    <td style="background-color: #f0f0f0;"></td>
                                </tr>
                            </table>
                        </td>
                        <td class="bar-value"><?= (int) $stats['totalIncident'] ?></td>
                    </tr>
                    <tr>
                        <td class="bar-label">Complete</td>
                        <td class="bar-cell">
                            <table class="bar-track" cellpadding="0" cellspacing="0">
                                <tr>
                                    <?php if ($barWidths['incidentComplete'] > 0): ?>
                                    <td style="width: <?= $barWidths['incidentComplete'] ?>%; background-color: #73ea2c;"></td>
                                    <?php endif; ?>
                                    <td style="background-color: #f0f0f0;"></td>
                                </tr>
                            </table>
                        </td>
                        <td class="bar-value"><?= (int) $stats['totalIncidentComplete'] ?></td>
                    </tr>
                </table>

                <div class="chart-group-label">
                    Requests (<?= (int) $stats['totalRequest'] ?>) - <?= $requestCompleteRateDisplay ?>% complete
                </div>
                <table class="bars">
                    <tr>
                        <td class="bar-label">Created</td>
                        <td class="bar-cell">
                            <table class="bar-track" cellpadding="0" cellspacing="0">
                                <tr>
                                    <?php if ($barWidths['requestCreated'] > 0): ?>
                                    <td style="width: <?= $barWidths['requestCreated'] ?>%; background-color: #a32828;"></td>
                                    <?php endif; ?>
                                    <td style="background-color: #f0f0f0;"></td>
                                </tr>
                            </table>
                        </td>
                        <td class="bar-value"><?= (int) $stats['totalRequest'] ?></td>
                    </tr>
                    <tr>
                        <td class="bar-label">Complete</td>
                        <td class="bar-cell">
                            <table class="bar-track" cellpadding="0" cellspacing="0">
                                <tr>
                                    <?php if ($barWidths['requestComplete'] > 0): ?>
                                    <td style="width: <?= $barWidths['requestComplete'] ?>%; background-color: #73ea2c;"></td>
                                    <?php endif; ?>
                                    <td style="background-color: #f0f0f0;"></td>
                                </tr>
                            </table>
                        </td>
                        <td class="bar-value"><?= (int) $stats['totalRequestComplete'] ?></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <table class="stats">
        <thead>
            <tr>
                <th>Incidents</th>
                <th>Incidents Resolved</th>
                <th>Requests</th>
                <th>Requests Completed</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><?= (int) $stats['totalIncident'] ?></td>
                <td><?= (int) $stats['totalIncidentComplete'] ?></td>
                <td><?= (int) $stats['totalRequest'] ?></td>
                <td><?= (int) $stats['totalRequestComplete'] ?></td>
            </tr>
        </tbody>
    </table>

    <p>
        Of all the requests received, <?= (int) $stats['totalOutstanding'] ?> remain outstanding which are
        either currently being worked on, are on hold awaiting a user response, or are waiting to be
        assigned to a technician.
    </p>

    <table class="stats">
        <thead>
            <tr>
                <th>Unassigned</th>
                <th>In-Progress</th>
                <th>On Hold</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><?= (int) $stats['new'] ?></td>
                <td><?= (int) $stats['progress'] ?></td>
                <td><?= (int) $stats['hold'] ?></td>
            </tr>
        </tbody>
    </table>

    <?php if (($this->reportConfig['include_unresolved'] ?? false) === true && ! empty($this->unresolved)): ?>
    <?php
    $unresolvedFields = $this->reportConfig['unresolved_fields'] ?? [];
    $fieldCount       = count($unresolvedFields);
    $groups           = [];
    foreach ($this->unresolved as $row) {
        $groupKey            = $row['type'] ?? 'Other';
        $groups[$groupKey][] = $row;
    }
    ?>
    <div class="page-break"></div>
    <h2 style="font-size: 14pt; margin: 0 0 8pt 0;">Open Tickets (<?= count($this->unresolved) ?>)</h2>
    <p class="unresolved-meta" style="margin: 0 0 6pt 0;">
        Showing <?= count($this->unresolved) ?> of <?= (int) $stats['totalOutstanding'] ?> open tickets created in the period.
    </p>
    <?php foreach ($groups as $groupLabel => $rows): ?>
    <h3 style="font-size: 12pt; margin: 12pt 0 6pt 0;"><?= $this->escapeHtml($groupLabel) ?></h3>
    <table class="unresolved">
        <thead>
            <tr>
                <?php if (in_array('id', $unresolvedFields, true)): ?>
                <th>ID</th>
                <?php endif; ?>
                <?php if (in_array('created', $unresolvedFields, true)): ?>
                <th>Created</th>
                <?php endif; ?>
                <?php if (in_array('due', $unresolvedFields, true)): ?>
                <th>Due</th>
                <?php endif; ?>
                <?php if (in_array('updated', $unresolvedFields, true)): ?>
                <th>Last Updated</th>
                <?php endif; ?>
                <?php if (in_array('type', $unresolvedFields, true)): ?>
                <th>Type</th>
                <?php endif; ?>
                <?php if (in_array('contact', $unresolvedFields, true)): ?>
                <th>Contact</th>
                <?php endif; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($rows as $row): ?>
            <tr class="unresolved-desc">
                <td colspan="<?= $fieldCount ?>" class="unresolved-meta">
                    <span class="bold"><?= $this->escapeHtml($row['description']) ?></span>
                </td>
            </tr>
            <tr>
                <?php if (in_array('id', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['id']) ?></td>
                <?php endif; ?>
                <?php if (in_array('created', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['created']) ?></td>
                <?php endif; ?>
                <?php if (in_array('due', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['due']) ?></td>
                <?php endif; ?>
                <?php if (in_array('updated', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['updated']) ?></td>
                <?php endif; ?>
                <?php if (in_array('type', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['type']) ?></td>
                <?php endif; ?>
                <?php if (in_array('contact', $unresolvedFields, true)): ?>
                <td class="unresolved-meta"><?= $this->escapeHtml($row['contact']) ?></td>
                <?php endif; ?>
            </tr>
            <tr class="unresolved-sep">
                <td colspan="<?= $fieldCount ?>">&nbsp;</td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php endforeach; ?>
    <?php endif; ?>
    <div class="footer"></div>
</body>
</html>
