<?php
$this->headTitle('Home');

$this->headLink()->appendStylesheet('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.css');
$this->inlineScript()->appendFile('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js');

?>
<div class="container-fluid">
    <div class="row">
        <div class="col">
        <h1>Ticket Summary</h1>
        </div>
    </div>
    <hr style=" border-top: 1px dotted #999999;">
    <div class="row">
        <div class="col">
            <a href="<?= $this->url('ticket.list') ?>?show=all" class="text-decoration-none">
                <div class="card mb-1 hover-shadow" style="cursor: pointer;">
                    <div class="card-header text-nowrap text-center text-body">
                        Total Tickets
                    </div>
                    <div class="card-body text-center text-body">
                        <h3><?= $this->stats['created'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list_status', ['status_id' => 4]) ?>" class="text-decoration-none">
                <div class="card mb-1 hover-shadow" style="cursor: pointer;">
                    <div class="card-header text-nowrap text-center text-body">
                        Resolved Tickets
                    </div>
                    <div class="card-body text-center text-body">
                        <h3><?= $this->stats['resolved'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list_status', ['status_id' => 5]) ?>" class="text-decoration-none">
                <div class="card mb-1 hover-shadow" style="cursor: pointer;">
                    <div class="card-header text-nowrap text-center text-body">
                        Closed Tickets
                    </div>
                    <div class="card-body text-center text-body">
                        <h3><?= $this->stats['closed'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 g-3 mb-3">
        <div class="col">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white text-center">
                    SLA Incidents
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="text-uppercase small text-muted">SLA Compliance</div>
                        <div class="display-6 fw-semibold"><?= number_format($this->stats['sla']['compliance'], 1) ?>%</div>
                        <small class="text-muted">This Month</small>
                    </div>
                    <dl class="row mb-0">
                        <dt class="col-7 text-uppercase small text-muted">Avg Resolution</dt>
                        <dd class="col-5 text-end fw-semibold"><?= $this->stats['sla']['avgResolutionDisplay'] ?></dd>
                        <dt class="col-7 text-uppercase small text-muted">Tickets Resolved</dt>
                        <dd class="col-5 text-end fw-semibold"><?= (int) $this->stats['sla']['resolved'] ?></dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white text-center">
                    Service Requests (No SLA)
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="text-uppercase small text-muted">Avg Resolution</div>
                        <div class="display-6 fw-semibold"><?= $this->stats['service']['avgResolutionDisplay'] ?></div>
                        <small class="text-muted">This Month</small>
                    </div>
                    <dl class="row mb-0">
                        <dt class="col-7 text-uppercase small text-muted">Tickets Resolved</dt>
                        <dd class="col-5 text-end fw-semibold"><?= (int) $this->stats['service']['resolved'] ?></dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <hr style=" border-top: 1px dotted #999999;">

    <div class="row">
        <div class="col">
            <a href="<?= $this->url('ticket.list') ?>?filter=overdue" class="text-decoration-none">
                <div class="card mb-1 text-center hover-shadow" style="cursor: pointer;">
                    <div class="card-header bg-danger text-white text-nowrap">
                        Overdue
                    </div>
                    <div class="card-body text-body">
                        <h3><?= $this->stats['overdue'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list') ?>?filter=duetoday" class="text-decoration-none">
                <div class="card mb-1 text-center hover-shadow" style="cursor: pointer;">
                    <div class="card-header bg-warning text-dark text-nowrap">
                        Due today
                    </div>
                    <div class="card-body text-body">
                        <h3><?= $this->stats['dueToday'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list') ?>?filter=unresolved" class="text-decoration-none">
                <div class="card mb-1 text-center hover-shadow" style="cursor: pointer;">
                    <div class="card-header bg-primary text-white text-nowrap">
                        Unresolved
                    </div>
                    <div class="card-body text-body">
                        <h3><?= $this->stats['unresolved'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list_status', ['status_id' => 1]) ?>" class="text-decoration-none">
                <div class="card mb-1 text-center hover-shadow" style="cursor: pointer;">
                    <div class="card-header bg-success text-white text-nowrap">
                        New/Open
                    </div>
                    <div class="card-body text-body">
                        <h3><?= $this->stats['open'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="<?= $this->url('ticket.list_status', ['status_id' => 3]) ?>" class="text-decoration-none">
                <div class="card mb-1 text-center hover-shadow" style="cursor: pointer;">
                    <div class="card-header bg-info text-white text-nowrap">
                        On hold
                    </div>
                    <div class="card-body text-body">
                        <h3><?= $this->stats['hold'] ?></h3>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <hr style=" border-top: 1px dotted #999999;">

<?php
$agentStats = $this->stats['agent'] ?? [];
usort($agentStats, function ($a, $b) {
    return ($b['Resolved'] ?? 0) <=> ($a['Resolved'] ?? 0);
});

$topAgents = array_slice($agentStats, 0, 5);

$chartData = [
    'names'    => [],
    'open'     => [],
    'resolved' => [],
];

foreach ($agentStats as $agent) {
    $chartData['names'][]    = $agent['name'];
    $chartData['open'][]     = (int) ($agent['open'] ?? 0);
    $chartData['resolved'][] = (int) ($agent['Resolved'] ?? 0);
}
?>

    <div class="row gy-3">
        <div class="col-12 col-lg-7">
            <div class="card h-100">
                <div class="card-header text-nowrap">
                    Agent Performance
                </div>
                <div class="card-body">
                    <?php if (empty($chartData['names'])): ?>
                        <div class="text-center text-muted py-4">No agent activity recorded yet.</div>
                    <?php else: ?>
                        <div class="ratio ratio-16x9" style="min-height: 260px;">
                            <canvas id="agentPerformanceChart"></canvas>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-5">
            <div class="card h-100">
                <div class="card-header text-nowrap">
                    Top Agents (This Month)
                </div>
                <div class="card-body p-0">
                    <?php if (empty($topAgents)): ?>
                        <div class="p-3 text-muted">No agent activity recorded yet.</div>
                    <?php else: ?>
                        <div class="list-group list-group-flush">
                            <?php foreach ($topAgents as $agent): ?>
                                <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div>
                                        <div class="fw-semibold"><?= $this->escapeHtml($agent['name']) ?></div>
                                        <div class="small text-muted">
                                            Resolved: <?= (int) ($agent['Resolved'] ?? 0) ?> Â· Open: <?= (int) ($agent['open'] ?? 0) ?>
                                        </div>
                                    </div>
                                    <span class="badge bg-success text-white">
                                        <?= (int) ($agent['Resolved'] ?? 0) ?> closed
                                    </span>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
<?php $this->inlineScript()->captureStart(); ?>
    (function () {
        var labels = <?= json_encode($chartData['names']) ?>;
        if (!labels.length) {
            return;
        }

        var canvas = document.getElementById('agentPerformanceChart');
        if (!canvas) {
            return;
        }

        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Open',
                        data: <?= json_encode($chartData['open']) ?>,
                        backgroundColor: 'rgba(163,40,40,0.6)',
                        borderColor: 'rgba(163,40,40,0.9)',
                        borderWidth: 1,
                    },
                    {
                        label: 'Resolved',
                        data: <?= json_encode($chartData['resolved']) ?>,
                        backgroundColor: 'rgba(115,234,44,0.6)',
                        borderColor: 'rgba(115,234,44,0.9)',
                        borderWidth: 1,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Agent Statistics for <?= \Carbon\Carbon::now()->format('F') ?>',
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            precision: 0,
                        }
                    }]
                }
            }
        });
    })();
<?php
$this->inlineScript()->captureEnd();
